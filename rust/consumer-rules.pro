====================================================================
Файл: consumer-rules.pro
Назначение: Защита сгенерированных UniFFI-методов от R8/Proguard.
АУДИТ: Этот файл предотвращает поломку JNI-вызовов в Release-сборках.
====================================================================
1. ЗАЩИТА СГЕНЕРИРОВАННЫХ КЛАССОВ FFI
UniFFI генерирует:
- Классы, которые реализуют интерфейсы UDL (например, InnertubeClient).
- Нативные методы JNI, которые вызывают Rust-функции.
Если эти методы обфусцируются или удаляются, приложение падает с UnsatisfiedLinkError.
Мы сохраняем все публичные методы и поля в сгенерированном пакете.
-keep class app.vitune.rust.** {
# Сохраняем все поля и методы (включая приватные, которые могут быть JNI-обертками)
public *;
private *;
protected *;
}
2. ЗАЩИТА СИСТЕМНЫХ ТРЕБОВАНИЙ UNIFFI
UniFFI требует, чтобы его внутренние классы (например, FFIConverter) не обфусцировались.
-keep interface org.mozilla.uniffi.UniFfiTag
3. ЗАЩИТА КЛАССОВ ИСКЛЮЧЕНИЙ (Rust Errors)
Сохраняем классы ошибок, сгенерированные из UDL (например, InnertubeError),
чтобы их можно было корректно поймать в Kotlin.
-keepclassmembers class * implements org.mozilla.uniffi.FfiConverter {
<init>(...);
}
4. ЗАЩИТА JNA (Если используется - но UniFFI обычно не требует)
Если UniFFI или другая часть проекта использует JNA, нужно добавить
-keep class com.sun.jna.** { *; }
Но поскольку мы используем чистый UniFFI, этот пункт можно опустить для минимализма.
